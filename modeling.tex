\section{Response Time Model Creation}\label{model_creation}

\subsection*{Response Time Modeling}

To create RTF models either at install time or online we use a least squares approach described a below.  For the install time approach we use a genetic algorithm, Audze-Eglasis Design of Experiments\cite{bates-aes03}, to select the resource vectors to use for training data.  The data for all those vectors is collected and fed into the least squares algorithm.  In the online approach the data comes from the application's response time history.

\subsubsection*{Model Creation using Least Squares}
After sufficient measurements, discovery of the model parameters $w$ that define the function $\tau$ can be based on a solution to the over-determined linear system
$t=Dw$
where $t$ is a column vector of actual response times measured for the application
and $D$ is a matrix whose ith row $D_{i,*}$ contains the reciprocals of the amplified bandwidth allocations
that generated the corresponding response time measurement $t_i$.
Estimating $w$ is relatively straightforward: a least-squares solution accomplished via
\emph{QR factorization}\cite{GoVL} of $D$ will determine the $w$ that minimizes (half the)
square of the \emph residual error $1/2 \|Dw - t\|^2_2 = 1/2 \|\varepsilon\|^2_2$.
The solution proceeds as follows:
\begin{eqnarray*}
t     &=& Dw  - \varepsilon    \\
      &=& QRw - \varepsilon    \\
Q^Tt  &=& Rw  - Q^T\varepsilon
\end{eqnarray*}

It is not always necessary to materialize the orthogonal matrix $Q^T = Q^{-1}$;
the individual elementary orthogonal transformations (Householder reflections or Givens rotations)
that triangularize $R$ by progressively zeroing out partial columns of $D$ can simultaneously be applied to $t$.
The elements of the resulting vector $Q^Tt$ that correspond to zero rows in $R$ comprise $-Q^T\varepsilon$.
Since $Rw$ exactly equals the upper part of $Q^Tt$, the upper part of $Q^T\varepsilon$ is zero. The residual error for the $t_i$
can be found by premultiplying $Q^T\varepsilon$ by $Q$.

This formulation assumes a model norm $p = 1$. If a different model norm $p$ is desired, such as $p = 2$, we could first square each measurement in $t$
and each reciprocal bandwidth term in $D$ and then follow the foregoing procedure.
The elements of the result $w$ will be squares as well, and the 2-norm of the difference in the squared quantities will be minimized.  This is not the same as minimizing the 4-norm; what is being minimized is $1/2\|\mbox{diag}(Dww^TD^T - tt^T)\|^2_2$.

\subsection*{On-line Response Time Modeling}

As resource allocation continues, more measurements will become available to augment $t$ and $D$.
Moreover, older data may become a poor representation of the current behavior of the application if its characteristics have changed,
presumably as reflected in $Q^T\varepsilon$.  \pacora adopts the incremental least squares described below to replace old data and efficiently update RTFs.

\subsubsection*{Incremental Least Squares}

What is needed is a factorization $\tilde{Q}\tilde{R}$ of a new matrix $\tilde{D}$
derived from $D$ by dropping a row, perhaps from the bottom,
and adding a row, perhaps at the top.
Corresponding elements of $t$ are dropped and added to form $\tilde{t}$.

The matrices $\tilde{Q}$ and $\tilde{R}$ can be generated by applying Givens rotations
in the way described in Section 12 of \cite{GoVL} to \emph{downdate} or \emph{update} the factorization
much more cheaply than recomputing it \emph{ab initio}.
The method requires retention and maintenance of $Q^T$ but not of $D$.
Every update in \pacora is preceded by a downdate that makes room for it.
Downdated rows are \emph{not} always the oldest (bottom) ones, but
an update always adds a new top row.
For several reasons, the number of rows $m$ in $R$
will be at least twice the number of columns $n$.
Rows selected for downdating will always be in the lower $m - n$ rows of $R$,
guaranteeing that the most recent $n$ updates are always part of the model.



\subsubsection*{Non-Negativity}

To guarantee convexity of the response time model, the solution $w$ to $t \approx QRw$ must have no negative components.
Intuitively, when a resource is associated with more than a single $w_j$
or when the measured response time increases with allocation then negative $w_j$ may occur.

A requirement for non-negative solutions to least-squares linear algebra problems is common,
so much so that it has a name: \emph{Non Negative Least Squares}, or NNLS.
There are several well-known techniques\cite{ChPl},
but since the method proposed here for online model maintenance calls for
incremental downdates and updates to rows of $Q^T$, $Q^Tt$ and $R$,
the NNLS problem is handled with a complementary scheme
based on the \emph{active-set} method\cite{LaHa} that
also downdates and updates the \emph{columns} of $R$ incrementally,
roughly in the spirit of Algorithm~3 in~\cite{LuDu}.
However, \pacora's algorithm cannot ignore downdated columns of $R$
because subsequent \emph{row} updates and downdates must have due effect
on these columns to allow their later reintroduction via column updates when necessary.
/pacora solves this problem by leaving the downdated columns in place,
skipping over them in maintaining and using the QR factorization. 

\subsubsection*{Model Rank Preservation}

If care is not taken in the allocation process,
the rows of $R$ may become linearly dependent
to such an extent that its rank is insufficient to determine $w$.
This might be the result of repetitions in resource assignment updates.
There are several possible ways to avoid this \emph{rank-deficiency} problem.
The characteristics of $R$ depend on both the resource optimization trajectory and the
choices made in the downdate-update algorithm.
In particular, deciding whether to downdate the bottom row of $R$ or some ``younger'' row
will depend on whether the result would become rank-deficient.
This approach decouples allocation optimization from performance model maintenance
and places responsibility upon the latter to always keep enough history to determine a model.

\subsubsection*{Outliers and Phase Changes}

Some response time measurements may be ``noisy'' or even erroneous.
A weakness of least-squares modeling is the high importance it gives to outlying values.
On the other hand, when an application changes phase it is important to adapt quickly,
and what looks like an outlier when it first appears may be a harbinger of change.
What is needed is a way to discard either old or outlying data
with a judicious balance between age and anomaly.

The downdating algorithm accomplishes this by weighting the errors in $\varepsilon = Q(Q^Tt - Rw)$
between the predicted response times $\tau$ and the measured ones $t$ by a factor
that increases exponentially with the age $g(i)$ of the error $\varepsilon_i$.
Age can be modeled coarsely by the number of time quanta of some size since the measurement;
\pacora simply lets $g(i) = i$.
The weighting factor for the $i$th row is then $\eta^{g(i)}$ where $\eta$ is a constant somewhat greater than 1.
The candidate row to downdate is the row with the largest weighted error, \emph{i.e.}
\begin{displaymath}
dd = \arg\max_i |\varepsilon_i| \cdot \eta^{g(i)}
\end{displaymath}



